<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AlertSense - Emergency Sound Detector</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', sans-serif;
    background-color: #fff;
    color: #333;
    text-align: center;
    padding: 20px;
    transition: background-color .2s ease;
  }

  /* BURGER MENU */
  #menuBtn {
    position: absolute;
    top: 15px;
    left: 15px;
    font-size: 28px;
    cursor: pointer;
    background: none;
    border: none;
    color: #ff6600;
  }

  h1 {
    margin-top: 40px;
    color: #ff6600;
    font-size: 32px;
  }

  #status {
    font-size: 24px;
    font-weight: bold;
    margin: 15px 0;
    color: #ff6600;
  }

  #detected {
    font-size: 19px;
    margin-bottom: 25px;
  }

  button {
    padding: 14px 30px;
    border-radius: 25px;
    border: none;
    background-color: #ff6600;
    color: white;
    font-size: 17px;
    margin: 8px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    transition: 0.2s;
  }

  button:hover { background-color: #e65c00; }

  body.emergency { background-color: #ff3300 !important; color: white; }

  #emergencyCall {
    margin-top: 15px;
    background-color: #cc0000;
  }

  /* --- BUTTON ANIMATIONS --- */
.animated-btn {
    background: #ff5555;
    color: white;
    padding: 14px 22px;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.15s ease, background-color 0.15s ease;
    width: 100%;
    max-width: 280px;
}

/* Hover effect (PC) */
.animated-btn:hover {
    transform: scale(0.97);
    background: #e14b4b;
}

/* Mobile press effect */
.animated-btn:active {
    transform: scale(0.94);
    background: #c94444;
}

</style>
</head>
<body>

<!-- BURGER MENU BUTTON -->
<button id="menuBtn" onclick="openSettings()">â˜°</button>

<h1>AlertSense</h1>

<div id="status">Idle</div>
<div id="detected">Sound Detected: None</div>

<button id="startBtn" class="animated-btn">Start Listening</button>
<button id="stopBtn" class="animated-btn">Stop Listening</button>

<!-- Emergency Call -->
<button id="emergencyCall" onclick="fakeCall()">Emergency Contact</button>

<a href="how-to-use.html" style="margin-top:25px; display:block; color:#ff6600;">How to use AlertSense?</a>


<!-- TensorFlow -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<script>
/* ------------------------------- */
/* TEMPORARY STORAGE (Resets On Refresh) */
/* ------------------------------- */
let contactNumber = "N/A";
let historyLog = [];

/* ------------------------------- */
/* MODEL CONFIG */
/* ------------------------------- */
const checkpointURL = "https://shielaoriola.github.io/tm-sound-model/model/model.json";
const metadataURL   = "https://shielaoriola.github.io/tm-sound-model/model/metadata.json";

let recognizer;
let classLabels;
let listening = false;
let flashInterval;
let consecutiveDetections = 0;

let wakeLockObj = null;

/* ------------------------------- */
/* SETTINGS PAGE LINK */
/* ------------------------------- */
function openSettings() {
    window.location.href = "settings.html";
}

/* ------------------------------- */
/* CONFIRMATION TIMER */
/* ------------------------------- */
let confirmTimer = null;

/* ------------------------------- */
/* MODEL INIT */
/* ------------------------------- */
async function initModel() {
    recognizer = speechCommands.create("BROWSER_FFT", undefined, checkpointURL, metadataURL);
    await recognizer.ensureModelLoaded();
    classLabels = recognizer.wordLabels();
}

/* ------------------------------- */
/* HANDLE RESULTS */
/* ------------------------------- */
function handleResult(result) {
    const scores = result.scores;
    const maxIndex = scores.indexOf(Math.max(...scores));
    const detected = classLabels[maxIndex];
    const probability = scores[maxIndex];

    document.getElementById("detected").innerText = "Sound Detected: " + detected;

    const emergencyKeywords = ["Whistle", "Siren", "Help", "Crying"];

    if (emergencyKeywords.includes(detected) && probability > 0.85) {
        consecutiveDetections++;

        if (consecutiveDetections >= 2) {

            if (!confirmTimer) {
                confirmTimer = setTimeout(() => {
                    triggerEmergency(detected);
                }, 3000); // 3 sec confirmation
            }
        }
    } else {
        consecutiveDetections = 0;
        clearTimeout(confirmTimer);
        confirmTimer = null;
        document.getElementById("status").innerText = listening ? "Listening..." : "Idle";
        stopFlashing();
    }
}

/* ------------------------------- */
/* EMERGENCY TRIGGER */
/* ------------------------------- */
function triggerEmergency(type) {
    document.getElementById("status").innerText = "EMERGENCY SOUND DETECTED!";
    startFlashing();

    historyLog.push("Detected: " + type + " at " + new Date().toLocaleTimeString());

    if (navigator.vibrate) navigator.vibrate([500, 500, 500]);

    if (contactNumber !== "N/A") {
        window.location.href = "tel:" + contactNumber;
    }
}

/* ------------------------------- */
/* FLASHING RED SCREEN */
/* ------------------------------- */
function startFlashing() {
    if (!flashInterval) {
        flashInterval = setInterval(() => {
            document.body.classList.toggle("emergency");
        }, 450);
    }
}

function stopFlashing() {
    clearInterval(flashInterval);
    flashInterval = null;
    document.body.classList.remove("emergency");
}

/* ------------------------------- */
/* START / STOP LISTENING */
/* ------------------------------- */
async function startListening() {

    if (!recognizer) await initModel();

    listening = true;
    document.getElementById("status").innerText = "Listening...";
    document.getElementById("detected").innerText = "Sound Detected: None";

    enableWakeLock();

    recognizer.listen(handleResult, {
        probabilityThreshold: 0.75,
        includeSpectrogram: true,
        overlapFactor: 0.5,
        invokeCallbackOnNoiseAndUnknown: true
    });
}

function stopListening() {
    listening = false;

    if (recognizer) recognizer.stopListening();

    document.getElementById("status").innerText = "Idle";
    stopFlashing();
    disableWakeLock();
}

/* ------------------------------- */
/* EMERGENCY CONTACT BUTTON */
/* ------------------------------- */
function fakeCall() {
    if (contactNumber === "N/A") {
        alert("No emergency contact set.");
        return;
    }
    window.location.href = "tel:" + contactNumber;
}

/* ------------------------------- */
/* WAKE LOCK */
/* ------------------------------- */
async function enableWakeLock() {
    try {
        wakeLockObj = await navigator.wakeLock.request("screen");
    } catch (err) {
        console.log("Wake Lock not supported");
    }
}

function disableWakeLock() {
    try {
        if (wakeLockObj) wakeLockObj.release();
    } catch {}
}
</script>
</body>
</html>
