<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TM Sound Listener</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>TM Sound Listener</h2>
  <p id="status">Loading model...</p>

  <!-- Official TM Sound CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/sound@0.8.3/dist/teachablemachine-sound.min.js"></script>

  <script>
    console.log("tmSound library:", window.tmSound);

    const URL = "./model/";
    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";

    let model, microphone;

    async function init() {
      try {
        if (!window.tmSound) throw new Error("TM Sound library not loaded");

        console.log("Loading model...");
        model = await tmSound.load(modelURL, metadataURL);
        console.log("Model loaded:", model);

        microphone = new tmSound.Microphone();
        await microphone.open();
        console.log("Microphone opened");

        document.getElementById("status").innerText = "Mic active âœ“";
        predictLoop();

      } catch (err) {
        console.error("Initialization error:", err);
        document.getElementById("status").innerText = "Error: " + err;
      }
    }

    async function predictLoop() {
      try {
        const prediction = await model.predict(microphone);
        const best = prediction[0];
        document.getElementById("status").innerText =
          `Detected: ${best.className} (${best.probability.toFixed(2)})`;

        if (window.AppInventor) {
          window.AppInventor.setWebViewString(JSON.stringify(best));
        }
      } catch (err) {
        console.error("Prediction error:", err);
      }
      requestAnimationFrame(predictLoop);
    }

    window.onload = init;
  </script>
</body>
</html>
